---
title: "Social vulnerability indicators - Adaptive capacity"
author: "LGCarlson"
date: "9/29/2021"
output: 
  html_document:
    toc: true
    toc_float: false
    theme: flatly
    highlight: haddock
    df_print: paged
    code_folding: show
---

```{r setup, include=FALSE}

library(tidyverse)
library(here)
library(janitor)
library(snakecase)
library(scales)
library(forcats)

knitr::opts_chunk$set(echo = TRUE)

nth_element <- function(vector, starting_position, n) { 
  vector[seq(starting_position, length(vector), n)] 
}
```


### Read in data

```{r read data,message=F}
# data to match COCA and Colburn Community names
match_names<-read_csv(here::here("metadata", "match_communities_Colburn_to_COCA.csv"))

# sub-dataset for latitudinal sorting
lat_sort_df <- match_names %>% select(COCA_clean,lat_sort)



# full, raw, social indicator dataset
social_indicators_original<-read_csv(here::here("input_data", "socialIndicatorData_2011-2015_allUSA.csv")) 
```


### Create clean social indicators dataset with only communities and indicators of interest 

_Indicators to include:_

* Poverty

* Labor Force

* Housing Characteristics

* Population Composition

* Personal Disruption

* Housing Disruption



```{r clean data}
social_indicators_clean<-social_indicators_original %>% 
  janitor::clean_names() %>%       # clean column names
  mutate(community_name = gsub("/", " ", community_name)) %>%  # replace / with space
  mutate(community_name = gsub("[()]", "", community_name)) %>%   # remove parentheses
  mutate(ColburnCommunity = paste(community_name, state, sep = ", ")) %>%   
  right_join(match_names, by = "ColburnCommunity")  %>%   # keep only communities of interest
  dplyr::select(ColburnCommunity,COCA_clean, COCACommunity, year, community_name,state,region, 
                latitude, longitude,lat_sort,
                poverty_categorical_ranking, 
                labor_force_categorical_ranking,
                housing_characteristics_categorical_ranking, 
                population_composition_categorical_ranking,
                personal_disruption_categorical_ranking,
                housing_disruption_categorical_ranking) %>%  #select social indicator columns of interest
  filter(year %in% c(2011,2012,2013,2014,2015))   # filter to years of study


# length(unique(social_indicators_clean$COCACommunity)) should = 144
```


### Reverse categorical rankings

Presently, low categorical rankings = low vulnerability/high adaptive capacity and high categorical rankings = high vulnerability/low adaptive capacity

__Old:__

* 0 - lowest vulnerability

* 1 - low vulnerability

* 2 - medium vulnerability

* 3 - high vulnerability

* 4 - highest vulnerability


However, we are interested in calculate adaptive capacity, so we want to reverse the categorical rankings such that  low rankings = low adaptive capacity and high rankings = high adaptive capacity

__New:__

* 0 - lowest adaptive capacity

* 1 - low adaptive capcity

* 2 - medium adaptive capacity

* 3 - high adaptive capcity

* 4 - highest adaptive capcity


```{r reverse rankings}
social_indicators_long<-social_indicators_clean %>% 
  gather(key="category", value="vulnerability_ranking", 11:16) %>% 
  mutate(category = gsub("_categorical_ranking", "", category)) 


social_indicators_long$adaptive_capacity_ranking<-NA
social_indicators_long$adaptive_capacity_ranking[social_indicators_long$vulnerability_ranking == 0] = 4
social_indicators_long$adaptive_capacity_ranking[social_indicators_long$vulnerability_ranking == 1] = 3
social_indicators_long$adaptive_capacity_ranking[social_indicators_long$vulnerability_ranking == 2] = 2
social_indicators_long$adaptive_capacity_ranking[social_indicators_long$vulnerability_ranking == 3] = 1
social_indicators_long$adaptive_capacity_ranking[social_indicators_long$vulnerability_ranking == 4] = 0
```

### Calculate adaptive capacity summary statistics

```{r calculate summary stats}
adaptive_capacity_stats<-social_indicators_long %>%  
  group_by(COCA_clean) %>%
  summarise(sum_adaptcapacity=sum(adaptive_capacity_ranking, na.rm = T),
            mean_adaptcapacity=mean(adaptive_capacity_ranking,na.rm = T), 
            sd_adaptcapacity=sd(adaptive_capacity_ranking),
            se_adaptcapacity=sd_adaptcapacity/6, 
            min_adaptcapacity=min(adaptive_capacity_ranking),
            max_adaptcapacity=max(adaptive_capacity_ranking), 
            range_adaptcapacity = max_adaptcapacity-min_adaptcapacity) 
```


### Fig. 1 Visualize mean adaptive capacity by community

```{r data vis 1,echo=F,fig.height=18,fig.width=10,fig.align="center"}
adaptive_capacity_plot<-adaptive_capacity_stats %>% 
  left_join(lat_sort_df, by = "COCA_clean") %>% 
  ggplot(aes(x=fct_reorder(COCA_clean,lat_sort,.desc = T), y=mean_adaptcapacity)) +
  geom_errorbar(aes(ymin=mean_adaptcapacity-se_adaptcapacity,ymax=mean_adaptcapacity+se_adaptcapacity),width = 0.5, alpha=0.5,size=0.5) + 
  geom_point(size=2) + 
  coord_flip() + labs(x="", y="Mean (+/-se)",
       title="Adaptive capacity across six categories (2011-2015)") +
  scale_y_continuous(breaks = c(1,2,3,4,5), labels = c("Very Low", "Low", "Medium", "High", "Very High"))
adaptive_capacity_plot
```



#### Rescale data

```{r}
#0 to 1 rescale
adaptive_capacity_final<-adaptive_capacity_stats %>% 
  select(COCA_clean,mean_adaptcapacity)


adaptive_capacity_final$rescaled_adaptcapacity = scales::rescale(adaptive_capacity_final$mean_adaptcapacity, to=c(0,1))
```






### Fig.2 Visualize rescaled adaptive capacity by community

```{r data vis 2,echo=F,fig.height=18,fig.width=10,fig.align="center"}
adaptive_capacity_rescaled<-adaptive_capacity_final %>% 
  left_join(lat_sort_df, by = "COCA_clean") %>% 
  ggplot(aes(x=fct_reorder(COCA_clean,lat_sort,.desc = T), y=rescaled_adaptcapacity)) +
  geom_point(size=2) + 
  coord_flip() + labs(x="", y="Mean (rescaled 0 to 1)",
       title="Adaptive capacity across six categories (rescaled 0 to 1)") 
adaptive_capacity_rescaled
```




### Save outputs

#### Data

```{r write data to csv}
#write_csv(adaptive_capacity_final,here::here("output_data","adaptive_capacity_rescaled.csv"))
```

#### Figures

```{r output figure}
#ggsave(here::here("output_figures/adaptive_capacity","mean_adaptive_capacity.pdf"),plot=adaptive_capacity_plot, height = 18,width = 10)

#ggsave(here::here("output_figures/adaptive_capacity","mean_adaptive_capacity_rescaled.pdf"),plot=adaptive_capacity_rescaled, height = 18,width = 10)
```



